clear
clc

A = [0 1; 0 -4];
B = [0; 3];
C = [1 0];
K = [4 1];
L = [-2; 13];

D = 0
kref = -inv(C*inv(A-B*K)*B);
syms s
F = simplify((K*inv(s*eye(size(A))-(A-B*K-L*C))*B*kref-kref)/(-K*inv(s*eye(size(A))-(A-B*K-L*C))*L))
G = simplify(K*inv(s*eye(size(A))-(A-B*K-L*C))*L)
H = simplify(C*inv(s*eye(size(A))-A)*B+D)

%%
clear
clc

A = [-4 5 1; -3 -5 3; 5 -1 -5];
B = [-2; 5; 2];
C = [-1 4 2];
K = [-1 2 -1];
L = [4; 3; -1];

%Am = A-B*K-L*C
%Bm = L
%Cm = -K

%syms s
%G = Cm*inv(s*eye(size(Am))-Am)*Bm
%simplify(G)

syms s
G = K*inv(s*eye(size(A))-(A-B*K-L*C))*L
simplify(G)
%%
clear
clc

A = [-3 5; -4 -3];
B = [3; -3];
C = [5 5];
D = [0];
syms s
H = simplify(C * inv(s * eye(size(A)) - A) * B+D)

w = 3.9;
H_at_w = double(subs(H, s, j*w))
M = abs(H_at_w)
theta = angle(H_at_w)

%%
clear
clc

L = 2

w = [0.0100000000 0.0120679264 0.0145634848 0.0175751062 0.0212095089 0.0255954792 0.0308884360 0.0372759372 0.0449843267 0.0542867544 0.0655128557 0.0790604321 0.0954095476 0.1151395399 0.1389495494 0.1676832937 0.2023589648 0.2442053095 0.2947051703 0.3556480306 0.4291934260 0.5179474679 0.6250551925 0.7543120063 0.9102981780 1.0985411420 1.3257113656 1.5998587196 1.9306977289 2.3299518105 2.8117686980 3.3932217719 4.0949150624 4.9417133613 5.9636233166 7.1968567300 8.6851137375 10.4811313415 12.6485521686 15.2641796718 18.4206996933 22.2299648253 26.8269579528 32.3745754282 39.0693993705 47.1486636346 56.8986602902 68.6648845004 82.8642772855 100.0000000000];
mag = [1.0253050418 1.0254390607 1.0254579356 1.0253095207 1.0252932203 1.0249169116 1.0247471008 1.0243375806 1.0239210136 1.0232552428 1.0225090467 1.0208456368 1.0188212113 1.0160754123 1.0117143949 1.0056788905 0.9970013432 0.9847288379 0.9678179124 0.9444438399 0.9131550980 0.8726804627 0.8218872729 0.7614208878 0.6930286777 0.6190845712 0.5432538462 0.4694038371 0.4007393309 0.3387086276 0.2841310282 0.2372115204 0.1973474544 0.1638896919 0.1360429026 0.1127906083 0.0936175871 0.0775732622 0.0642598801 0.0532934627 0.0441117495 0.0365548843 0.0302845158 0.0250508494 0.0208836610 0.0171075004 0.0142706530 0.0117210979 0.0097933184 0.0080070492];
ang = [-3.1296847259 -3.1269692193 -3.1240480650 -3.1202539103 -3.1160524487 -3.1106016220 -3.1042065276 -3.0965125011 -3.0872584227 -3.0760687165 -3.0626005847 -3.0464391391 -3.0269270711 -3.0033142873 -2.9751423592 -2.9418555595 -2.9013815759 -2.8541527151 -2.7986633164 -2.7341838229 -2.6608686169 -2.5785670788 -2.4890884077 -2.3940050166 -2.2970180280 -2.2011246029 -2.1098270392 -2.0258922371 -1.9503939550 -1.8855901648 -1.8302450882 -1.7842319604 -1.7462434040 -1.7151476651 -1.6897068594 -1.6688478460 -1.6517422061 -1.6377416207 -1.6260059180 -1.6165950095 -1.6087287804 -1.6022843153 -1.5968672346 -1.5924162264 -1.5886721983 -1.5854495604 -1.5829752781 -1.5810459997 -1.5791545899 -1.5776628818];

s = 1j * w;
H = mag .* exp(1j * ang);
P = [];
for i=1:length(H)
    t = [];
    for j=1:L
        t = [t,s(i)^(L-j)];
    end
    for j=1:L
        t = [t,-s(i)^(L-j)*H(i)];
    end
    P=[P;t];
end
r = [];
for i=1:length(H)
    r=[r;s(i)^L*H(i)];
end

P = [real(P);
     imag(P)];
r = [real(r);
     imag(r)];

q = inv(P'*P)*P'*r;
b = [];
for i=1:L
    b = [b,q(i)];
end
disp(mat2str(b))
a = [];
for i=L+1:2*L
    a = [a,q(i)];
end
disp(mat2str(a))


%% 
clear
clc

A = [0 1; 2 4];
B = [0; 3];
C = [1 0];
K = [2 3];
L = [8; 37];

D=0;
kref=-inv(C*inv(A-B*K)*B);

syms s
H = simplify(C*inv(s*eye(size(A))-A)*B+D);
G = simplify(K*inv(s*eye(size(A))-(A-B*K-L*C))*L);
F = simplify((K*inv(s*eye(size(A))-(A-B*K-L*C))*B*kref-kref)/(-K*inv(s*eye(size(A))-(A-B*K-L*C))*L));


tau = .05185;
n_pade = 1;
[num, den] = pade(tau, n_pade);
T = poly2sym(num, s) / poly2sym(den, s);
T = simplify(T*H*G*F/(1+T*H*G));
[N,D] = numden(T);
M = coeffs(D,s);
M = vpa(fliplr(M),3);
vpa(roots(M),4)